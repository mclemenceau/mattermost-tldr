name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Lint (ruff)
        run: ruff check .

      - name: Format check (ruff)
        run: ruff format --check .

      - name: Format check (black)
        run: black --check .

      - name: Type check (mypy)
        run: mypy src/

      - name: Run tests
        run: pytest

      - name: Verify tag matches pyproject.toml version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          TOML_VERSION=$(grep '^version = ' pyproject.toml \
            | sed 's/version = "\(.*\)"/\1/')
          echo "Tag version:    ${TAG_VERSION}"
          echo "pyproject.toml: ${TOML_VERSION}"
          if [ "${TAG_VERSION}" != "${TOML_VERSION}" ]; then
            echo ""
            echo "ERROR: Tag v${TAG_VERSION} does not match pyproject.toml version ${TOML_VERSION}."
            echo "Update pyproject.toml before tagging, then re-push the tag."
            exit 1
          fi

      - name: Build distribution packages
        run: python -m build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*
